open Domain
open DecisionTree
open AbstractSyntax
open Config
open Apron
open InvMap

let block_label block = 
  match block with
  | A_empty l -> l
  | A_block (l,_,_) -> l
let print fmt join =
    Format.printf "@[" ;
    List.iter
      (fun (l, nl, cns) ->
        Format.printf "@[" ;
        let _ =
                Format.printf "@[ Non-vulnerable:" ;
                Format.print_newline () ;
                Format.printf " " ;
                List.iter
                  (fun x -> Format.printf "%s{%s}-" x.varId x.varName)
                  l ;
                Format.printf "@]";
                Format.print_newline ()
              in
              let _ =
                Format.print_newline () ;
                Format.printf "@[ Potentially vulnerable:" ;
                Format.print_newline () ;
                Format.printf " " ;
                List.iter
                  (fun x -> Format.printf "%s{%s}-" x.varId x.varName)
                  nl ;
                Format.printf "@]";
                Format.print_newline ();
                Format.print_space ();
              in
              let _ = Format.printf "@[ Constraints :"; 
                      Format.print_newline (); 
                      Format.printf " " ;
              in
              let _ =
                Array.iter
                  (fun c ->
                    Abstract1.print Format.std_formatter c ;
                    Format.print_newline (); 
                    Format.printf " " ;
                    )
                  cns
              in
              Format.printf "@]\n";
              Format.print_newline () ;
              Format.printf "@[ + Join constraint:" ;
              (* TODO: Underapproximation join: let _ = Abstract1.print Format.std_formatter j in *)
              Format.printf "@]\n" ;
              Format.printf "@]" ; Format.print_newline ();
      )
        
              
              join 
    ;
    Format.printf "@]";
    Format.printf "MaxInf: %d\n" (List.fold_left (fun m (v1,v2,a) ->  let cur = List.length v1 in  if m < cur then cur else m) 0 join );
    Format.printf "Nb vuln: %d\n" (List.fold_left (fun m (v1,v2,a) ->  if List.length v2 > 0 then m+1 else m ) 0 join );
    Format.printf "Total: %d\n" (try
                                  let l,nl,_ = List.hd join in List.length l + List.length nl
                                 with  _ -> 0)

let analyse vulnerable vars f m =
  Format.printf "@[ environnment " ;
  List.iter (fun s -> Format.printf "%s " s.varName) vars ;
  Format.printf "@]\n\n" ;
  (* get label at start of block *)
  let initialLabel = block_label f.funcBody in
  let i = (InvMap.find initialLabel m) in
  print !Config.fmt (vulnerable i)
  

